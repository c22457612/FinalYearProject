<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VPT Control Centre - Site Insights</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/site-insights.css" />
</head>

<body class="site-page">
  <header class="site-header">
    <div class="site-header-left">
      <a class="back-link" href="/">&larr; Back to Control Centre</a>
      <h1 id="siteTitle">Site insights</h1>
      <div id="siteSubtitle" class="site-subtitle">Loading...</div>
    </div>

    <div class="site-header-right">
      <span id="siteConnectionStatus" class="badge">Connecting...</span>
      <div class="site-actions">
        <button id="exportSiteCsvBtn" class="btn-export" disabled>Download CSV</button>
        <button id="exportSiteJsonBtn" class="btn-export" disabled>Download JSON</button>
      </div>
    </div>
  </header>

  <div class="site-content">
    <section class="summary site-summary">
      <div class="summary-card">
        <h2>Total events</h2>
        <div id="siteStatTotal" class="value">0</div>
        <div class="hint">stored in SQLite</div>
      </div>

      <div class="summary-card">
        <h2>Blocked</h2>
        <div id="siteStatBlocked" class="value">0</div>
        <div class="hint">network.blocked</div>
      </div>

      <div class="summary-card">
        <h2>Observed</h2>
        <div id="siteStatObserved" class="value">0</div>
        <div class="hint">network.observed</div>
      </div>

      <div class="summary-card">
        <h2>Unique 3rd parties</h2>
        <div id="siteStatUniqueThird" class="value">0</div>
        <div class="hint">domains detected</div>
      </div>
    </section>

    <section class="site-grid">
      <div class="panel site-viz-panel">
        <div class="panel-header">
          <div>
            <div id="vizTitle" class="panel-title">Visualisation</div>
            <div class="panel-subtitle">Auto-updates as new events arrive</div>
          </div>

          <div class="viz-controls">
            <button id="vizInfoBtn" class="viz-nav" type="button">Explain / Info</button>
            <button id="vizOpenDrawerBtn" class="viz-nav" type="button" disabled>Technical details</button>
          </div>
        </div>

        <div class="viz-guided-actions">
          <button id="filterResetBtn" class="viz-nav" type="button">Reset filters</button>
        </div>

        <details id="advancedControlsPanel" class="viz-advanced-panel">
          <summary>Advanced chart options</summary>
          <div class="viz-advanced-panel-body">
            <div class="viz-filters">
              <div class="kind-toggles">
                <label class="kind-toggle"><input id="kindBlockedToggle" type="checkbox" checked />Blocked</label>
                <label class="kind-toggle"><input id="kindObservedToggle" type="checkbox" checked />Observed</label>
                <label class="kind-toggle"><input id="kindOtherToggle" type="checkbox" checked />Other</label>
              </div>

              <label class="viz-label" for="partyFilter">Party</label>
              <select id="partyFilter" class="viz-select">
                <option value="all" selected>All</option>
                <option value="third">Third-party</option>
                <option value="first_or_unknown">First/unknown</option>
              </select>

              <label class="viz-label" for="resourceFilter">Resource</label>
              <select id="resourceFilter" class="viz-select">
                <option value="all" selected>All</option>
                <option value="script">Script</option>
                <option value="xhr_fetch">XHR/Fetch</option>
                <option value="image">Image</option>
                <option value="sub_frame">Sub-frame</option>
                <option value="other">Other</option>
              </select>

              <label class="viz-label" for="surfaceFilter">Surface</label>
              <select id="surfaceFilter" class="viz-select">
                <option value="all" selected>All</option>
                <option value="network">Network</option>
                <option value="cookies">Cookies</option>
                <option value="storage">Storage</option>
                <option value="browser_api">Browser API</option>
                <option value="script">Script</option>
                <option value="unknown">Unknown</option>
              </select>

              <label class="viz-label" for="privacyStatusFilter">Privacy</label>
              <select id="privacyStatusFilter" class="viz-select">
                <option value="all" selected>All</option>
                <option value="baseline">Baseline</option>
                <option value="signal_detected">Signal detected</option>
                <option value="high_risk">High risk</option>
                <option value="policy_blocked">Policy blocked</option>
                <option value="policy_allowed">Policy allowed</option>
                <option value="unknown">Unknown</option>
              </select>

              <label class="viz-label" for="mitigationStatusFilter">Mitigation</label>
              <select id="mitigationStatusFilter" class="viz-select">
                <option value="all" selected>All</option>
                <option value="allowed">Allowed</option>
                <option value="blocked">Blocked</option>
                <option value="observed_only">Observed only</option>
                <option value="modified">Modified</option>
                <option value="unknown">Unknown</option>
              </select>

              <input id="domainFilter" class="viz-select viz-domain-input" placeholder="Filter domain/url..." />
              <button id="vizClearSelectionBtn" class="viz-nav" type="button">Clear selection</button>
            </div>

            <div class="viz-advanced-options">
              <label class="viz-label" for="vizMetricSelect">Metric</label>
              <select id="vizMetricSelect" class="viz-select">
                <option value="seen" selected>Seen</option>
                <option value="blocked">Blocked</option>
                <option value="observed">Observed</option>
              </select>

              <label class="viz-label" for="vizSeriesTypeSelect">Series</label>
              <select id="vizSeriesTypeSelect" class="viz-select">
                <option value="auto" selected>Auto</option>
                <option value="bar">Bar</option>
                <option value="line">Line</option>
                <option value="area">Area</option>
              </select>

              <label class="viz-label" for="vizTopNSelect">Top N</label>
              <select id="vizTopNSelect" class="viz-select">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="40">40</option>
              </select>

              <label class="viz-label" for="vizSortSelect">Sort</label>
              <select id="vizSortSelect" class="viz-select">
                <option value="value_desc" selected>Value desc</option>
                <option value="value_asc">Value asc</option>
                <option value="label_asc">Label A-Z</option>
              </select>

              <label class="viz-label" for="vizBinSizeSelect">Bin size</label>
              <select id="vizBinSizeSelect" class="viz-select">
                <option value="1m">1m</option>
                <option value="5m" selected>5m</option>
                <option value="15m">15m</option>
                <option value="60m">60m</option>
              </select>

              <label class="kind-toggle"><input id="vizNormalizeToggle" type="checkbox" />Normalize %</label>
              <label class="kind-toggle"><input id="vizStackToggle" type="checkbox" checked />Stack bars</label>
            </div>
          </div>
        </details>

        <div class="vendor-drilldown">
          <div class="vendor-drill-header">
            <div class="panel-subtitle">Vendor drilldown</div>
            <button id="clearVendorBtn" class="viz-nav" type="button">Clear vendor</button>
          </div>
          <div id="vendorChips" class="vendor-chips"></div>
        </div>
        <div id="vendorScopeBanner" class="vendor-scope-banner hidden"></div>
        <div id="vendorSelectionCue" class="vendor-selection-cue hidden" aria-live="polite">
          <div id="vendorSelectionCueText" class="vendor-selection-cue-text"></div>
          <button id="vendorSelectionCueBtn" class="viz-nav" type="button">View details</button>
        </div>

        <div id="filterSummary" class="panel-subtitle filter-summary">
          Showing 0 of 0 events
        </div>

        <div id="vizStateGuidance" class="viz-state-guidance hidden"></div>
        <div id="vizLensNotice" class="viz-lens-notice hidden"></div>
        <div id="vizKpiStrip" class="viz-kpi-strip"></div>
        <ul id="vizCallouts" class="viz-callouts"></ul>

        <div class="viz-wrap">
          <div id="vizChart" class="viz-chart"></div>
        </div>
        <div class="viz-bottom-nav">
          <div class="viz-arrow-group">
            <button id="vizPrevBtn" class="viz-nav" type="button" title="Previous">&larr;</button>
            <button id="vizNextBtn" class="viz-nav" type="button" title="Next">&rarr;</button>
          </div>
          <div class="viz-mode-group">
            <label class="viz-label" for="vizSelect">Mode</label>
            <select id="vizSelect" class="viz-select">
              <option value="vendorOverview">Vendor activity overview</option>
              <option value="riskTrend">Risk trend timeline</option>
              <option value="baselineDetectedBlockedTrend">Baseline vs detected vs blocked trend</option>
              <option value="timeline">Activity timeline (last 24h)</option>
              <option value="topSeen">Top third-party domains (seen)</option>
              <option value="kinds">Event breakdown (kind)</option>
              <option value="apiGating">3P API-like calls (heuristic)</option>
              <option value="vendorKindMatrix">Vendor-kind matrix</option>
              <option value="ruleIdFrequency">Rule ID frequency</option>
              <option value="resourceTypes">Resource type breakdown</option>
              <option value="modeBreakdown">Protection mode breakdown</option>
              <option value="partySplit">Party split (first vs third)</option>
              <option value="hourHeatmap">Activity heatmap (hour x day)</option>
            </select>
          </div>
          <div id="vizPositionLabel" class="viz-position-label">1 / 1</div>
        </div>
        <div id="vizModeHelp" class="viz-mode-help"></div>

        <section id="insightSheet" class="insight-sheet">
          <div class="insight-sheet-header">
            <div>
              <div id="insightTitle" class="panel-title">Info</div>
              <div id="insightMeta" class="panel-subtitle">Select a chart point to explain current evidence.</div>
            </div>
          </div>
          <div class="insight-sheet-body">
            <div id="insightSeverity" class="insight-severity severity-info">Info</div>
            <div id="insightSelectedLead" class="insight-selected-lead">You selected: no datapoint yet.</div>
            <div class="insight-block">
              <div class="insight-label">What</div>
              <div id="insightSummary"></div>
            </div>
            <div class="insight-block">
              <div class="insight-label">How</div>
              <div id="insightHow"></div>
            </div>
            <div class="insight-block">
              <div class="insight-label">Why</div>
              <ul id="insightWhy" class="insight-list"></ul>
            </div>
            <div class="insight-block">
              <div class="insight-label">Limits</div>
              <ul id="insightLimits" class="insight-list"></ul>
            </div>
            <div id="insightActions" class="insight-actions"></div>
          </div>
        </section>
      </div>

      <div class="site-right">
        <div class="panel sidebar-config-panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">Sidebar modules</div>
              <div class="panel-subtitle">Select one module to show in this column</div>
            </div>
          </div>
          <div class="sidebar-module-picker" role="tablist" aria-label="Sidebar module selector">
            <button id="sidebarModuleBtnFilters" class="sidebar-module-btn sidebar-module-btn-priority" type="button" role="tab">View</button>
            <button id="sidebarModuleBtnRecentEvents" class="sidebar-module-btn" type="button" role="tab">Recent events</button>
            <button id="sidebarModuleBtnSelectedEvidence" class="sidebar-module-btn" type="button" role="tab">Selected evidence</button>
            <button id="sidebarModuleBtnVendorProfile" class="sidebar-module-btn" type="button" role="tab">Vendor profile</button>
            <button id="sidebarModuleBtnTopThirdParties" class="sidebar-module-btn" type="button" role="tab">Top third-party domains</button>
          </div>
        </div>

        <div id="sidebarModuleTopThirdParties" class="panel sidebar-module" data-sidebar-module="topThirdParties">
          <div class="panel-header">
            <div>
              <div class="panel-title">Top third-party domains</div>
              <div class="panel-subtitle">Latest tracker activity on this site</div>
            </div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Seen</th>
                  <th>Blocked</th>
                  <th>Observed</th>
                </tr>
              </thead>
              <tbody id="topThirdBody">
                <tr><td colspan="4" class="muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="sidebarModuleRecentEvents" class="panel sidebar-module" data-sidebar-module="recentEvents">
          <div class="panel-header">
            <div>
              <div class="panel-title">Recent events</div>
              <div class="panel-subtitle">Last 100 events for this site</div>
            </div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Kind</th>
                  <th>Domain</th>
                  <th>Mode</th>
                </tr>
              </thead>
              <tbody id="recentEventsBody">
                <tr><td colspan="4" class="muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="sidebarModuleSelectedEvidence" class="panel sidebar-module" data-sidebar-module="selectedEvidence">
          <div class="panel-header">
            <div>
              <div class="panel-title">Selected evidence</div>
              <div id="sidebarSelectedEvidenceMeta" class="panel-subtitle">No datapoint selected yet.</div>
            </div>
          </div>
          <div id="sidebarSelectedEvidenceBody" class="sidebar-module-body"></div>
        </div>

        <div id="sidebarModuleFilters" class="panel sidebar-module" data-sidebar-module="filters">
          <div class="panel-header">
            <div>
              <div class="panel-title">View controls</div>
              <div id="sidebarFiltersMeta" class="panel-subtitle">Primary mode and range controls</div>
            </div>
          </div>
          <div class="sidebar-module-body">
            <div class="view-module-controls">
              <div class="view-module-row">
                <label class="viz-label" for="viewModeSelect">View</label>
                <select id="viewModeSelect" class="viz-select view-module-select">
                  <option value="easy" selected>Easy</option>
                  <option value="power">Power</option>
                </select>
              </div>
              <div class="view-module-row">
                <label class="viz-label" for="rangeSelect">Range</label>
                <select id="rangeSelect" class="viz-select view-module-select">
                  <option value="24h" selected>Last 24h</option>
                  <option value="1h">Last 1h</option>
                  <option value="7d">Last 7d</option>
                  <option value="all">All time</option>
                </select>
              </div>
            </div>
            <div id="sidebarFiltersSummary" class="panel-subtitle">No filters applied.</div>
            <ul id="sidebarFiltersList" class="sidebar-mini-list"></ul>
            <div class="sidebar-actions">
              <button id="sidebarResetFiltersBtn" class="viz-nav" type="button">Reset filters</button>
            </div>
          </div>
        </div>

        <div id="sidebarModuleVendorProfile" class="panel sidebar-module" data-sidebar-module="vendorProfile">
          <div class="panel-header">
            <div>
              <div class="panel-title">Vendor profile</div>
              <div id="sidebarVendorProfileMeta" class="panel-subtitle">Quick stats for current vendor scope</div>
            </div>
          </div>
          <div id="sidebarVendorProfileBody" class="sidebar-module-body"></div>
        </div>
      </div>
    </section>
  </div>

  <div id="vizDrawerBackdrop" class="drawer-backdrop hidden"></div>

  <aside id="vizDrawer" class="drawer hidden">
    <div class="drawer-header">
      <div id="drawerTitle" class="drawer-title">Selection</div>
      <button id="drawerCloseBtn" class="drawer-close">&times;</button>
    </div>

    <div class="drawer-body">
      <div class="drawer-toggle">
        <button id="drawerNormalBtn" class="drawer-tab active">Normal</button>
        <button id="drawerAdvancedBtn" class="drawer-tab">Advanced</button>
      </div>

      <div id="drawerSummary" class="drawer-summary"></div>
      <div id="drawerEvents" class="drawer-events"></div>
    </div>
  </aside>

  <div id="confirmModalBackdrop" class="modal-backdrop hidden"></div>
  <div id="confirmModal" class="confirm-modal hidden">
    <div class="panel-title" id="confirmTitle">Confirm action</div>
    <div class="panel-subtitle" id="confirmBody"></div>
    <div class="confirm-actions">
      <button id="confirmCancelBtn" class="viz-nav" type="button">Cancel</button>
      <button id="confirmOkBtn" class="btn-export" type="button">Confirm</button>
    </div>
  </div>

  <div id="actionToast" class="action-toast hidden"></div>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="app/vendor-taxonomy.js"></script>
  <script src="app/insight-rules.js"></script>
  <script src="app/site-lens.js"></script>
  <script type="module" src="site.js"></script>
</body>
</html>


